version: "3"

vars:
  BUILD: build

tasks:
  deps:
    desc: asio
    vars:
      ASIO: https://sourceforge.net/projects/asio/files/asio/1.36.0%20%28Stable%29/asio-1.36.0.tar.gz/download
    cmds:
      - mkdir -p third_party/
      - wget -O third_party/asio.tar.gz {{.ASIO}}
      - tar -xvf third_party/asio.tar.gz -C third_party/
      - ln -sf asio-1.36.0 third_party/asio

  cmake:
    desc: cmake
    cmds:
      - >
        cmake -GNinja "-B{{.BUILD}}" 
        -DCMAKE_CXX_COMPILER=clang++ 
        -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        -DASIO_INCLUDE=third_party/asio/include
        .
  clean:
    desc: clean cmake build
    cmds:
      - rm -rf {{.BUILD}}
  build:
    desc: build with cmake --build
    cmds:
      - cmake --build "{{.BUILD}}"
  all:
    desc: cmake and build all targets
    deps:
      - cmake
    cmds:
      - task build
  fmt:
    desc: format all source files
    cmds:
      - >
        find . -iname '*.h' -o -iname '*.cc' -o -iname '*.hpp' |
        clang-format --style=file -i --files=/dev/stdin
